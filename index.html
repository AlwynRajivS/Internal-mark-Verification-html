<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Marks Compare — Professional Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- DataTables -->
  <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>
  <style>
    :root{
      --brand:#0d6efd;
      --muted:#6c757d;
      --success:#1aa06a;
      --danger:#e03a3a;
      --warning:#f0ad4e;
      --info:#17a2b8;
      --bg:#f7f9fc;
    }
    body{background:var(--bg);font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
    .card-contrast{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(18,38,63,0.06)}
    header .brand{font-weight:700;color:var(--brand);letter-spacing:0.2px}
    .stat-card .value{font-size:1.6rem;font-weight:700}
    .status-Match{background:rgba(26,160,106,0.08)}
    .status-Mismatch{background:rgba(224,58,58,0.06)}
    .status-MissingMaster{background:rgba(240,173,78,0.06)}
    .status-MissingRovan{background:rgba(23,162,184,0.06)}
    table.dataTable tbody td{vertical-align:middle}
    .small-muted{font-size:0.85rem;color:var(--muted)}
    .top-actions .btn{margin-right:8px}
    .template-list small{display:block;color:var(--muted)}
    .footer-note{font-size:0.85rem;color:#6b7280}
    /* responsive tweaks */
    @media (max-width: 900px){
      .stat-card .value{font-size:1.2rem}
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <header class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <div class="brand">Marks Compare</div>
        <div class="small-muted">Professional Dashboard — HTML / CSS / JavaScript (client-side)</div>
      </div>
      <div class="text-end small-muted">
        <div>Client-side processing • No files uploaded to server</div>
        <div class="mt-1"><a href="#" id="helpBtn">How to use</a></div>
      </div>
    </header>

    <!-- Upload & Templates -->
    <section class="card-contrast p-3 mb-4">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <div class="row gy-2">
            <div class="col-md-6">
              <label class="form-label">Master File (Dean Office)</label>
              <input id="masterFile" type="file" accept=".xlsx,.xls,.csv" class="form-control"/>
            </div>
            <div class="col-md-6">
              <label class="form-label">Rovan File</label>
              <input id="rovanFile" type="file" accept=".xlsx,.xls,.csv" class="form-control"/>
            </div>
          </div>
        </div>

        <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
          <div class="top-actions">
            <button id="compareBtn" class="btn btn-primary">Compare Now</button>
            <button id="resetBtn" class="btn btn-outline-secondary">Reset</button>
          </div>
          <div class="mt-3 template-list text-start text-lg-end">
            <small>Templates</small>
            <div class="mt-1">
              <button id="downloadMasterTpl" class="btn btn-sm btn-outline-primary">Download Master Template</button>
              <button id="downloadRovanTpl" class="btn btn-sm btn-outline-primary">Download Rovan Template</button>
            </div>
            <div class="mt-2 small-muted">Download editable templates to avoid format errors.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Dashboard -->
    <section class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card-contrast p-3 stat-card">
          <div class="small-muted">Total compared cells</div>
          <div class="value" id="totalCells">0</div>
          <div class="small-muted">Non-empty cells compared</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card-contrast p-3 stat-card">
          <div class="small-muted">Matches</div>
          <div class="value text-success" id="matches">0</div>
          <div class="small-muted" id="matchPercent">0%</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card-contrast p-3 stat-card">
          <div class="small-muted">Mismatches</div>
          <div class="value text-danger" id="mismatches">0</div>
          <div class="small-muted" id="mismatchPercent">0%</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card-contrast p-3 stat-card">
          <div class="small-muted">Missing (Master / Rovan)</div>
          <div class="value" id="missingCounts">0 / 0</div>
          <div class="small-muted">Cells missing in files</div>
        </div>
      </div>
    </section>

    <!-- Chart + Courses list -->
    <section class="card-contrast p-3 mb-4">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <canvas id="courseChart" height="120"></canvas>
        </div>
        <div class="col-lg-4">
          <h6 class="mb-2">Course Summary</h6>
          <div id="courseSummary" style="max-height:220px;overflow:auto"></div>
        </div>
      </div>
    </section>

    <!-- Results table -->
    <section class="card-contrast p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Detailed Report</h5>
        <div>
          <button id="downloadCSV" class="btn btn-sm btn-outline-success">Download CSV</button>
          <button id="downloadXlsx" class="btn btn-sm btn-outline-primary">Download XLSX</button>
        </div>
      </div>

      <div class="table-responsive">
        <table id="reportTable" class="display cell-border stripe" style="width:100%">
          <thead>
            <tr>
              <th>Register No</th>
              <th>Course</th>
              <th>Master Mark</th>
              <th>Rovan Mark</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="mt-3 footer-note">
        Tip: Use the table search box to quickly find a Register No or Course code.
      </div>
    </section>

    <footer class="text-center mt-4 small-muted">Built with SheetJS & Chart.js • Ready for GitHub Pages</footer>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
  // -------------------------
  // Utility functions
  // -------------------------
  const readFileAsArrayBuffer = (file) => new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = e => res(e.target.result);
    fr.onerror = e => rej(e);
    fr.readAsArrayBuffer(file);
  });

  function normalizeString(s){
    if(s === null || s === undefined) return "";
    return String(s).trim().toUpperCase();
  }

  function isRegisterLike(str){
    // heuristic: contains digits and at least 3 characters
    if(!str) return false;
    return /\d/.test(str) && str.trim().length >= 3;
  }

  function objectToCSV(rows, columns){
    const esc = v => `"${String(v).replace(/"/g,'""')}"`;
    const header = columns.map(esc).join(",");
    const lines = rows.map(r => columns.map(c => esc(r[c] ?? "")).join(","));
    return [header, ...lines].join("\r\n");
  }

  function downloadBlob(data, filename, mime){
    const blob = new Blob([data], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // -------------------------
  // Template generation
  // -------------------------
  document.getElementById('downloadMasterTpl').onclick = () => {
    const arr = [
      ["RegNo","MA3351","PH3251","CS3391"],
      ["2123001",18,20,19],
      ["2123002",15,18,20]
    ];
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(arr);
    XLSX.utils.book_append_sheet(wb, ws, "Master");
    const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
    downloadBlob(wbout, "Master_Template.xlsx", "application/octet-stream");
  };

  document.getElementById('downloadRovanTpl').onclick = () => {
    const arr = [
      ["RegNo","CS3391","MA3351","PH3251"],
      ["2123001",18,18,20],
      ["2123002",20,15,18]
    ];
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(arr);
    XLSX.utils.book_append_sheet(wb, ws, "Rovan");
    const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
    downloadBlob(wbout, "Rovan_Template.xlsx", "application/octet-stream");
  };

  // -------------------------
  // Compare logic
  // -------------------------
  async function parseToTable(file) {
    const ab = await readFileAsArrayBuffer(file);
    const wb = XLSX.read(ab, {type:'array'});
    const name = wb.SheetNames[0];
    const ws = wb.Sheets[name];
    // get JSON with raw values and preserve blank cells
    const json = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:""});
    // drop fully empty rows/cols
    // remove trailing empty rows
    while(json.length && json[json.length-1].every(c => c === "")) json.pop();
    // remove empty columns (by checking if every row that column is "")
    const cols = json[0] ? json[0].length : 0;
    const colNonEmpty = new Array(cols).fill(false);
    json.forEach(row => row.forEach((v,i) => { if(v !== "" && v !== null && v !== undefined) colNonEmpty[i] = true; }));
    // rebuild rows excluding empty trailing columns
    const maxCol = colNonEmpty.lastIndexOf(true) + 1 || cols;
    const cleaned = json.map(r => r.slice(0,maxCol));
    return cleaned;
  }

  function arrayToDataFrame(arr) {
    if(!arr || arr.length===0) return {header:[], rows:[]};
    const header = arr[0].map(c => c===null? "": String(c));
    const rows = arr.slice(1).map(r => {
      const obj = {};
      for(let i=0;i<header.length;i++) obj[header[i]??`COL${i}`] = r[i] ?? "";
      return obj;
    });
    return {header, rows};
  }

  function detectOrientation(df){
    // if first column contains many register-like values -> "rows" orientation
    const firstColVals = df.rows.map(r => normalizeString(r[df.header[0]]));
    const countRegLike = firstColVals.filter(v => isRegisterLike(v)).length;
    if(countRegLike >= Math.max(3, Math.floor(0.3*firstColVals.length))) return "rows";
    // else maybe transposed: check first row (headers) for register-like
    const firstRowHeaderLike = df.header.filter(h => isRegisterLike(h)).length;
    if(firstRowHeaderLike >= Math.max(3, Math.floor(0.3*df.header.length))) return "columns";
    // fallback to rows
    return "rows";
  }

  function dfToMatrix(df, orientation){
    // returns object {regs:[], courses:[], matrix: {reg: {course: value}}}
    const regs = new Set();
    const courses = new Set();
    const matrix = {}; // matrix[reg][course] = value

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Marks Compare — Professional Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- DataTables -->
  <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>
  <style>
    :root{
      --brand:#0d6efd;
      --muted:#6c757d;
      --success:#1aa06a;
      --danger:#e03a3a;
      --warning:#f0ad4e;
      --info:#17a2b8;
      --bg:#f7f9fc;
    }
    body{background:var(--bg);font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
    .card-contrast{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(18,38,63,0.06)}
    header .brand{font-weight:700;color:var(--brand);letter-spacing:0.2px}
    .stat-card .value{font-size:1.6rem;font-weight:700}
    .status-Match{background:rgba(26,160,106,0.08)}
    .status-Mismatch{background:rgba(224,58,58,0.06)}
    .status-MissingMaster{background:rgba(240,173,78,0.06)}
    .status-MissingRovan{background:rgba(23,162,184,0.06)}
    table.dataTable tbody td{vertical-align:middle}
    .small-muted{font-size:0.85rem;color:var(--muted)}
    .top-actions .btn{margin-right:8px}
    .template-list small{display:block;color:var(--muted)}
    .footer-note{font-size:0.85rem;color:#6b7280}
    /* responsive tweaks */
    @media (max-width: 900px){
      .stat-card .value{font-size:1.2rem}
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <header class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <div class="brand">Marks Compare</div>
        <div class="small-muted">Professional Dashboard — HTML / CSS / JavaScript (client-side)</div>
      </div>
      <div class="text-end small-muted">
        <div>Client-side processing • No files uploaded to server</div>
        <div class="mt-1"><a href="#" id="helpBtn">How to use</a></div>
      </div>
    </header>

    <!-- Upload & Templates -->
    <section class="card-contrast p-3 mb-4">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <div class="row gy-2">
            <div class="col-md-6">
              <label class="form-label">Master File (Dean Office)</label>
              <input id="masterFile" type="file" accept=".xlsx,.xls,.csv" class="form-control"/>
            </div>
            <div class="col-md-6">
              <label class="form-label">Rovan File</label>
              <input id="rovanFile" type="file" accept=".xlsx,.xls,.csv" class="form-control"/>
            </div>
          </div>
        </div>

        <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
          <div class="top-actions">
            <button id="compareBtn" class="btn btn-primary">Compare Now</button>
            <button id="resetBtn" class="btn btn-outline-secondary">Reset</button>
          </div>
          <div class="mt-3 template-list text-start text-lg-end">
            <small>Templates</small>
            <div class="mt-1">
              <button id="downloadMasterTpl" class="btn btn-sm btn-outline-primary">Download Master Template</button>
              <button id="downloadRovanTpl" class="btn btn-sm btn-outline-primary">Download Rovan Template</button>
            </div>
            <div class="mt-2 small-muted">Download editable templates to avoid format errors.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Dashboard -->
    <section class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card-contrast p-3 stat-card">
          <div class="small-muted">Total compared cells</div>
          <div class="value" id="totalCells">0</div>
          <div class="small-muted">Non-empty cells compared</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card-contrast p-3 stat-card">
          <div class="small-muted">Matches</div>
          <div class="value text-success" id="matches">0</div>
          <div class="small-muted" id="matchPercent">0%</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card-contrast p-3 stat-card">
          <div class="small-muted">Mismatches</div>
          <div class="value text-danger" id="mismatches">0</div>
          <div class="small-muted" id="mismatchPercent">0%</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card-contrast p-3 stat-card">
          <div class="small-muted">Missing (Master / Rovan)</div>
          <div class="value" id="missingCounts">0 / 0</div>
          <div class="small-muted">Cells missing in files</div>
        </div>
      </div>
    </section>

    <!-- Chart + Courses list -->
    <section class="card-contrast p-3 mb-4">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <canvas id="courseChart" height="120"></canvas>
        </div>
        <div class="col-lg-4">
          <h6 class="mb-2">Course Summary</h6>
          <div id="courseSummary" style="max-height:220px;overflow:auto"></div>
        </div>
      </div>
    </section>

    <!-- Results table -->
    <section class="card-contrast p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Detailed Report</h5>
        <div>
          <button id="downloadCSV" class="btn btn-sm btn-outline-success">Download CSV</button>
          <button id="downloadXlsx" class="btn btn-sm btn-outline-primary">Download XLSX</button>
        </div>
      </div>

      <div class="table-responsive">
        <table id="reportTable" class="display cell-border stripe" style="width:100%">
          <thead>
            <tr>
              <th>Register No</th>
              <th>Course</th>
              <th>Master Mark</th>
              <th>Rovan Mark</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="mt-3 footer-note">
        Tip: Use the table search box to quickly find a Register No or Course code.
      </div>
    </section>

    <footer class="text-center mt-4 small-muted">Built with SheetJS & Chart.js • Ready for GitHub Pages</footer>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
  // -------------------------
  // Utility functions
  // -------------------------
  const readFileAsArrayBuffer = (file) => new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = e => res(e.target.result);
    fr.onerror = e => rej(e);
    fr.readAsArrayBuffer(file);
  });

  function normalizeString(s){
    if(s === null || s === undefined) return "";
    return String(s).trim().toUpperCase();
  }

  function isRegisterLike(str){
    // heuristic: contains digits and at least 3 characters
    if(!str) return false;
    return /\d/.test(str) && str.trim().length >= 3;
  }

  function objectToCSV(rows, columns){
    const esc = v => `"${String(v).replace(/"/g,'""')}"`;
    const header = columns.map(esc).join(",");
    const lines = rows.map(r => columns.map(c => esc(r[c] ?? "")).join(","));
    return [header, ...lines].join("\r\n");
  }

  function downloadBlob(data, filename, mime){
    const blob = new Blob([data], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // -------------------------
  // Template generation
  // -------------------------
  document.getElementById('downloadMasterTpl').onclick = () => {
    const arr = [
      ["RegNo","MA3351","PH3251","CS3391"],
      ["2123001",18,20,19],
      ["2123002",15,18,20]
    ];
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(arr);
    XLSX.utils.book_append_sheet(wb, ws, "Master");
    const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
    downloadBlob(wbout, "Master_Template.xlsx", "application/octet-stream");
  };

  document.getElementById('downloadRovanTpl').onclick = () => {
    const arr = [
      ["RegNo","CS3391","MA3351","PH3251"],
      ["2123001",18,18,20],
      ["2123002",20,15,18]
    ];
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(arr);
    XLSX.utils.book_append_sheet(wb, ws, "Rovan");
    const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
    downloadBlob(wbout, "Rovan_Template.xlsx", "application/octet-stream");
  };

  // -------------------------
  // Compare logic
  // -------------------------
  async function parseToTable(file) {
    const ab = await readFileAsArrayBuffer(file);
    const wb = XLSX.read(ab, {type:'array'});
    const name = wb.SheetNames[0];
    const ws = wb.Sheets[name];
    // get JSON with raw values and preserve blank cells
    const json = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:""});
    // drop fully empty rows/cols
    // remove trailing empty rows
    while(json.length && json[json.length-1].every(c => c === "")) json.pop();
    // remove empty columns (by checking if every row that column is "")
    const cols = json[0] ? json[0].length : 0;
    const colNonEmpty = new Array(cols).fill(false);
    json.forEach(row => row.forEach((v,i) => { if(v !== "" && v !== null && v !== undefined) colNonEmpty[i] = true; }));
    // rebuild rows excluding empty trailing columns
    const maxCol = colNonEmpty.lastIndexOf(true) + 1 || cols;
    const cleaned = json.map(r => r.slice(0,maxCol));
    return cleaned;
  }

  function arrayToDataFrame(arr) {
    if(!arr || arr.length===0) return {header:[], rows:[]};
    const header = arr[0].map(c => c===null? "": String(c));
    const rows = arr.slice(1).map(r => {
      const obj = {};
      for(let i=0;i<header.length;i++) obj[header[i]??`COL${i}`] = r[i] ?? "";
      return obj;
    });
    return {header, rows};
  }

  function detectOrientation(df){
    // if first column contains many register-like values -> "rows" orientation
    const firstColVals = df.rows.map(r => normalizeString(r[df.header[0]]));
    const countRegLike = firstColVals.filter(v => isRegisterLike(v)).length;
    if(countRegLike >= Math.max(3, Math.floor(0.3*firstColVals.length))) return "rows";
    // else maybe transposed: check first row (headers) for register-like
    const firstRowHeaderLike = df.header.filter(h => isRegisterLike(h)).length;
    if(firstRowHeaderLike >= Math.max(3, Math.floor(0.3*df.header.length))) return "columns";
    // fallback to rows
    return "rows";
  }

  function dfToMatrix(df, orientation){
    // returns object {regs:[], courses:[], matrix: {reg: {course: value}}}
    const regs = new Set();
    const courses = new Set();
    const matrix = {}; // matrix[reg][course] = value

    if(orientation === "rows"){
      const regCol = df.header[0];
      df.rows.forEach(r => {
        const reg = normalizeString(r[regCol]);
        if(!reg) return;
        regs.add(reg);
        matrix[reg] = matrix[reg] || {};
        for(let i=1;i<df.header.length;i++){
          const course = normalizeString(df.header[i]);
          if(course === "") continue;
          courses.add(course);
          matrix[reg][course] = r[df.header[i]] === null? "" : String(r[df.header[i]]).trim();
        }
      });
    } else {
      // columns orientation: first row contains register nos as headers; first column is course codes
      // We'll transpose: header row are registers, first column of each row is course
      // df.header = array of column headers; df.rows are rows where first cell is course
      // treat df.header[1..] as reg nos and df.rows[*][0] as course names
      const regHeaders = df.header.slice(1).map(h => normalizeString(h));
      df.rows.forEach(r => {
        const course = normalizeString(r[df.header[0]]);
        if(!course) return;
        courses.add(course);
        for(let i=1;i<df.header.length;i++){
          const reg = regHeaders[i-1];
          if(!reg) continue;
          regs.add(reg);
          matrix[reg] = matrix[reg] || {};
          matrix[reg][course] = r[df.header[i]] === null? "" : String(r[df.header[i]]).trim();
        }
      });
    }
    return {
      regs: Array.from(regs).sort(),
      courses: Array.from(courses).sort(),
      matrix
    };
  }

  function unifyAndCompare(masterData, rovanData){
    const regs = Array.from(new Set([...masterData.regs, ...rovanData.regs])).sort();
    const courses = Array.from(new Set([...masterData.courses, ...rovanData.courses])).sort();

    const rows = [];
    const summary = {total:0, matches:0, mismatches:0, missing_master:0, missing_rovan:0};
    const perCourse = {};

    courses.forEach(c => perCourse[c] = {total:0, matches:0, mismatches:0, missing_master:0, missing_rovan:0});

    regs.forEach(reg => {
      courses.forEach(course => {
        const m = (masterData.matrix[reg] && masterData.matrix[reg][course]) ? normalizeString(masterData.matrix[reg][course]) : "";
        const r = (rovanData.matrix[reg] && rovanData.matrix[reg][course]) ? normalizeString(rovanData.matrix[reg][course]) : "";

        if(m === "" && r === "") return; // both empty -> ignore
        summary.total++;
        perCourse[course].total++;

        let status = "";
        if(m === "" && r !== ""){
          status = "Missing in Master";
          summary.missing_master++;
          perCourse[course].missing_master++;
        } else if(r === "" && m !== ""){
          status = "Missing in Rovan";
          summary.missing_rovan++;
          perCourse[course].missing_rovan++;
        } else if(m === r){
          status = "Match";
          summary.matches++;
          perCourse[course].matches++;
        } else {
          status = "Mismatch";
          summary.mismatches++;
          perCourse[course].mismatches++;
        }
        rows.push({Register:reg, Course:course, MasterMark: m, RovanMark: r, Status: status});
      });
    });

    summary.matchPercent = summary.total ? Math.round((summary.matches/summary.total)*10000)/100 : 0;
    summary.mismatchPercent = summary.total ? Math.round((summary.mismatches/summary.total)*10000)/100 : 0;
    return {rows, summary, perCourse};
  }

  // -------------------------
  // UI + Events
  // -------------------------
  let table = null;
  let lastResult = null;

  function renderSummary(summary){
    document.getElementById('totalCells').textContent = summary.total || 0;
    document.getElementById('matches').textContent = summary.matches || 0;
    document.getElementById('mismatches').textContent = summary.mismatches || 0;
    document.getElementById('matchPercent').textContent = `${summary.matchPercent || 0}%`;
    document.getElementById('mismatchPercent').textContent = `${summary.mismatchPercent || 0}%`;
    document.getElementById('missingCounts').textContent = `${summary.missing_master || 0} / ${summary.missing_rovan || 0}`;
  }

  function renderCourseSummary(perCourse){
    const el = document.getElementById('courseSummary');
    el.innerHTML = "";
    const arr = Object.keys(perCourse).map(k => ({course:k, ...perCourse[k]})).sort((a,b)=> b.mismatches - a.mismatches);
    arr.forEach(c => {
      if(c.total === 0) return;
      const pct = Math.round((c.mismatches / c.total)*10000)/100 || 0;
      const div = document.createElement('div');
      div.className = "py-1 mb-1 border-bottom";
      div.innerHTML = `<strong>${c.course}</strong> &nbsp; <span class="small-muted">(${c.total})</span>
        <div class="small-muted">Mismatch: ${c.mismatches} • MissingM:${c.missing_master} • MissingR:${c.missing_rovan} • ${pct}%</div>`;
      el.appendChild(div);
    });
    return arr;
  }

  let courseChart = null;
  function renderChart(perCourse){
    const data = Object.keys(perCourse).map(k => {
      const c = perCourse[k];
      return {course:k, mismatchPercent: c.total? Math.round((c.mismatches/c.total)*10000)/100 : 0, total:c.total};
    }).filter(x=>x.total>0).sort((a,b)=> b.mismatchPercent - a.mismatchPercent).slice(0,12);

    const labels = data.map(d=>d.course);
    const values = data.map(d=>d.mismatchPercent);
    const ctx = document.getElementById('courseChart').getContext('2d');
    if(courseChart) courseChart.destroy();
    courseChart = new Chart(ctx, {
      type:'bar',
      data:{labels, datasets:[{label:'Mismatch %', data:values}]},
      options:{responsive:true, scales:{y:{beginAtZero:true, max:100}}}
    });
  }

  function populateTable(rows){
    // destroy existing table
    if($.fn.dataTable.isDataTable('#reportTable')) {
      $('#reportTable').DataTable().clear().destroy();
      $('#reportTable tbody').empty();
    }
    const tbody = document.querySelector('#reportTable tbody');
    rows.forEach(r => {
      const tr = document.createElement('tr');
      let statusClass = '';
      if(r.Status === 'Match') statusClass = 'status-Match';
      else if(r.Status === 'Mismatch') statusClass = 'status-Mismatch';
      else if(r.Status === 'Missing in Master') statusClass = 'status-MissingMaster';
      else if(r.Status === 'Missing in Rovan') statusClass = 'status-MissingRovan';
      tr.className = statusClass;
      tr.innerHTML = `<td>${r.Register}</td>
                      <td>${r.Course}</td>
                      <td>${r.MasterMark}</td>
                      <td>${r.RovanMark}</td>
                      <td>${r.Status}</td>`;
      tbody.appendChild(tr);
    });
    table = $('#reportTable').DataTable({
      pageLength: 25,
      lengthMenu: [10,25,50,100],
      columns: [{},{},{},{},{searchable:true}],
      order: [[1,"asc"]]
    });
  }

  // Compare button
  document.getElementById('compareBtn').onclick = async () => {
    const masterFile = document.getElementById('masterFile').files[0];
    const rovanFile = document.getElementById('rovanFile').files[0];
    if(!masterFile || !rovanFile){
      alert('Please choose both Master and Rovan files.');
      return;
    }
    try {
      // parse both
      const [marr, rarr] = await Promise.all([parseToTable(masterFile), parseToTable(rovanFile)]);
      const mdf = arrayToDataFrame(marr);
      const rdf = arrayToDataFrame(rarr);
      const morient = detectOrientation(mdf);
      const rorient = detectOrientation(rdf);
      const mdata = dfToMatrix(mdf, morient);
      const rdata = dfToMatrix(rdf, rorient);
      const result = unifyAndCompare(mdata, rdata);
      lastResult = {result, mdata, rdata, morient, rorient};
      renderSummary(result.summary);
      renderCourseSummary(result.perCourse);
      renderChart(result.perCourse);
      populateTable(result.rows);
      // scroll to table
      document.querySelector('#reportTable').scrollIntoView({behavior:'smooth'});
    } catch(err){
      console.error(err);
      alert('Error parsing files. Please ensure they are valid Excel files.');
    }
  };

  // Reset
  document.getElementById('resetBtn').onclick = () => {
    document.getElementById('masterFile').value = "";
    document.getElementById('rovanFile').value = "";
    if($.fn.dataTable.isDataTable('#reportTable')) $('#reportTable').DataTable().clear().destroy();
    document.querySelector('#reportTable tbody').innerHTML = "";
    document.getElementById('totalCells').textContent = "0";
    document.getElementById('matches').textContent = "0";
    document.getElementById('mismatches').textContent = "0";
    document.getElementById('matchPercent').textContent = "0%";
    document.getElementById('mismatchPercent').textContent = "0%";
    document.getElementById('missingCounts').textContent = "0 / 0";
    if(courseChart) courseChart.destroy    if(orientation === "rows"){
      const regCol = df.header[0];
      df.rows.forEach(r => {
        const reg = normalizeString(r[regCol]);
        if(!reg) return;
        regs.add(reg);
        matrix[reg] = matrix[reg] || {};
        for(let i=1;i<df.header.length;i++){
          const course = normalizeString(df.header[i]);
          if(course === "") continue;
          courses.add(course);
          matrix[reg][course] = r[df.header[i]] === null? "" : String(r[df.header[i]]).trim();
        }
      });
    } else {
      // columns orientation: first row contains register nos as headers; first column is course codes
      // We'll transpose: header row are registers, first column of each row is course
      // df.header = array of column headers; df.rows are rows where first cell is course
      // treat df.header[1..] as reg nos and df.rows[*][0] as course names
      const regHeaders = df.header.slice(1).map(h => normalizeString(h));
      df.rows.forEach(r => {
        const course = normalizeString(r[df.header[0]]);
        if(!course) return;
        courses.add(course);
        for(let i=1;i<df.header.length;i++){
          const reg = regHeaders[i-1];
          if(!reg) continue;
          regs.add(reg);
          matrix[reg] = matrix[reg] || {};
          matrix[reg][course] = r[df.header[i]] === null? "" : String(r[df.header[i]]).trim();
        }
      });
    }
    return {
      regs: Array.from(regs).sort(),
      courses: Array.from(courses).sort(),
      matrix
    };
  }

  function unifyAndCompare(masterData, rovanData){
    const regs = Array.from(new Set([...masterData.regs, ...rovanData.regs])).sort();
    const courses = Array.from(new Set([...masterData.courses, ...rovanData.courses])).sort();

    const rows = [];
    const summary = {total:0, matches:0, mismatches:0, missing_master:0, missing_rovan:0};
    const perCourse = {};

    courses.forEach(c => perCourse[c] = {total:0, matches:0, mismatches:0, missing_master:0, missing_rovan:0});

    regs.forEach(reg => {
      courses.forEach(course => {
        const m = (masterData.matrix[reg] && masterData.matrix[reg][course]) ? normalizeString(masterData.matrix[reg][course]) : "";
        const r = (rovanData.matrix[reg] && rovanData.matrix[reg][course]) ? normalizeString(rovanData.matrix[reg][course]) : "";

        if(m === "" && r === "") return; // both empty -> ignore
        summary.total++;
        perCourse[course].total++;

        let status = "";
        if(m === "" && r !== ""){
          status = "Missing in Master";
          summary.missing_master++;
          perCourse[course].missing_master++;
        } else if(r === "" && m !== ""){
          status = "Missing in Rovan";
          summary.missing_rovan++;
          perCourse[course].missing_rovan++;
        } else if(m === r){
          status = "Match";
          summary.matches++;
          perCourse[course].matches++;
        } else {
          status = "Mismatch";
          summary.mismatches++;
          perCourse[course].mismatches++;
        }
        rows.push({Register:reg, Course:course, MasterMark: m, RovanMark: r, Status: status});
      });
    });

    summary.matchPercent = summary.total ? Math.round((summary.matches/summary.total)*10000)/100 : 0;
    summary.mismatchPercent = summary.total ? Math.round((summary.mismatches/summary.total)*10000)/100 : 0;
    return {rows, summary, perCourse};
  }

  // -------------------------
  // UI + Events
  // -------------------------
  let table = null;
  let lastResult = null;

  function renderSummary(summary){
    document.getElementById('totalCells').textContent = summary.total || 0;
    document.getElementById('matches').textContent = summary.matches || 0;
    document.getElementById('mismatches').textContent = summary.mismatches || 0;
    document.getElementById('matchPercent').textContent = `${summary.matchPercent || 0}%`;
    document.getElementById('mismatchPercent').textContent = `${summary.mismatchPercent || 0}%`;
    document.getElementById('missingCounts').textContent = `${summary.missing_master || 0} / ${summary.missing_rovan || 0}`;
  }

  function renderCourseSummary(perCourse){
    const el = document.getElementById('courseSummary');
    el.innerHTML = "";
  alert('Error parsing files. Please ensure they are valid Excel files.');
    }
  };

  // Reset
  document.getElementById('resetBtn').onclick = () => {
    document.getElementById('masterFile').value = "";
    document.getElementById('rovanFile').value = "";
    if($.fn.dataTable.isDataTable('#reportTable')) $('#reportTable').DataTable().clear().destroy();
    document.querySelector('#reportTable tbody').innerHTML = "";
    document.getElementById('totalCells').textContent = "0";
    document.getElementById('matches').textContent = "0";
    document.getElementById('mismatches').textContent = "0";
    document.getElementById('matchPercent').textContent = "0%";
    document.getElementById('mismatchPercent').textContent = "0%";
    document.getElementById('missingCounts').textContent = "0 / 0";
    if(courseChart) courseChart.destroy
