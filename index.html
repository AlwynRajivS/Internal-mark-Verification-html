<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Internal - Marks Compare (Pro)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- DataTables -->
  <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>

  <style>
    :root{
      --brand:#0b63ff; --bg:#f7fbff; --muted:#6b7280; --card:#ffffff;
      --success:#1aa06a; --danger:#e03a3a; --warn:#f59e0b; --info:#0ea5e9;
    }
    body { background:var(--bg); font-family:Inter, system-ui, Arial; color:#06314a; }
    .container{max-width:1200px}
    header{margin:18px 0}
    .brand { font-weight:700; font-size:1.25rem; color:var(--brand); }
    .card-block { background:var(--card); border-radius:12px; padding:16px; box-shadow:0 8px 20px rgba(12,30,60,0.06); }
    .stat .value { font-weight:700; font-size:1.4rem; }
    .small-muted { color:var(--muted); font-size:0.9rem; }
    .status-Match{ background:rgba(26,160,106,0.06) !important; }
    .status-Mismatch{ background:rgba(224,58,58,0.06) !important; }
    .status-MissingMaster{ background:rgba(245,158,11,0.06) !important; }
    .status-MissingRovan{ background:rgba(14,165,233,0.06) !important; }
    .top-actions .btn { margin-right:8px; }
    .file-label { font-weight:600; color:#0b2340; }
    .hint { font-size:0.86rem; color:var(--muted); }
    footer { margin-top:20px; color:var(--muted); font-size:0.85rem; text-align:center; }
    .select-reg { max-width:320px; }
    .missing-panel { max-height:220px; overflow:auto; border-left:4px solid #eee; padding-left:12px; }
    .mapping-table td, .mapping-table th { font-size:0.9rem; }
    @media (max-width:768px){ .card-block { padding:12px; } }
  </style>
</head>

<body>
<div class="container py-4">

  <!-- HEADER -->
  <header class="d-flex justify-content-between align-items-start">
    <div>
      <div class="brand">Internal - Marks Compare (Pro)</div>
      <div class="small-muted">RegNo column auto-detection & fuzzy course mapping</div>
    </div>
    <div class="text-end small-muted">Client-side • Handles rotated / shuffled sheets</div>
  </header>

  <!-- ============================ -->
  <!-- FILE UPLOAD -->
  <!-- ============================ -->
  <section class="card-block mb-4">
    <div class="row g-3">
      <div class="col-lg-7">

        <div class="row g-2">
          <div class="col-md-6">
            <label class="file-label">Master File (Dean Office)</label>
            <input id="masterFile" class="form-control" type="file" accept=".xlsx,.xls,.csv" />
            <div class="hint">Upload Master. Auto detect RegNo column.</div>
          </div>

          <div class="col-md-6">
            <label class="file-label">Rovan File</label>
            <input id="rovanFile" class="form-control" type="file" accept=".xlsx,.xls,.csv" />
            <div class="hint">Upload Rovan file.</div>
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-6">
            <label class="file-label">RegNo Column (Master)</label>
            <select id="masterRegCol" class="form-select select-reg">
              <option value="">— upload file to detect —</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="file-label">RegNo Column (Rovan)</label>
            <select id="rovanRegCol" class="form-select select-reg">
              <option value="">— upload file to detect —</option>
            </select>
          </div>
        </div>

      </div>



      
      <div class="col-lg-5 text-lg-end">
        <div class="top-actions mb-2">
          <button id="compareBtn" class="btn btn-primary">Compare Now</button>
          <button id="resetBtn" class="btn btn-outline-secondary">Reset</button>
        </div>

        <div class="mt-3">
          <button id="downloadMasterTpl" class="btn btn-sm btn-outline-primary">Master Template</button>
          <button id="downloadRovanTpl" class="btn btn-sm btn-outline-primary">Rovan Template</button>
        </div>

        <div class="mt-2 hint">
          Orientation: <strong id="orientInfo">Auto</strong>
          <div class="form-check form-switch mt-1">
            <input class="form-check-input" type="checkbox" id="forceTransposed">
            <label class="form-check-label small-muted">RegNo are columns (rotate)</label>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- ============================ -->
  <!-- STATS -->
  <!-- ============================ -->
  <section class="row g-3 mb-4">
    <div class="col-md-9">
      <div class="row g-3">

        <div class="col-sm-6 col-md-3">
          <div class="card-block stat">
            <div class="small-muted">Total Compared Cells</div>
            <div class="value" id="totalCells">0</div>
          </div>
        </div>

        <div class="col-sm-6 col-md-3">
          <div class="card-block stat">
            <div class="small-muted">Matches</div>
            <div class="value text-success" id="matches">0</div>
            <div class="small-muted" id="matchPercent">0%</div>
          </div>
        </div>

        <div class="col-sm-6 col-md-3">
          <div class="card-block stat">
            <div class="small-muted">Mismatches</div>
            <div class="value text-danger" id="mismatches">0</div>
            <div class="small-muted" id="mismatchPercent">0%</div>
          </div>
        </div>

        <div class="col-sm-6 col-md-3">
          <div class="card-block stat">
            <div class="small-muted">Missing (Master / Rovan)</div>
            <div class="value" id="missingCounts">0 / 0</div>
          </div>
        </div>

      </div>
    </div>
    <!-- Stats + missing columns panel -->
    <section class="row g-3 mb-4">
      <div class="col-md-9">
        <div class="row g-3">
          <div class="col-sm-6 col-md-3">
            <div class="card-block stat">
              <div class="small-muted">Total Compared Cells</div>
              <div class="value" id="totalCells">0</div>
              <div class="small-muted">Non-empty marks compared</div>
            </div>
          </div>

    <div class="col-md-3">
      <div class="card-block">
        <h6 class="mb-2">Missing Columns</h6>
        <div class="missing-panel">
          <div><strong>Master only:</strong> <span id="masterOnlyCount">0</span></div>
          <ul id="masterOnlyList" class="mb-2"></ul>
          <div><strong>Rovan only:</strong> <span id="rovanOnlyCount">0</span></div>
          <ul id="rovanOnlyList"></ul>
        </div>
      </div>
    </div>
  </section>

  <!-- ============================ -->
  <!-- CHART + MAPPING -->
  <!-- ============================ -->
  <section class="card-block mb-4">
    <div class="row">
      <div class="col-lg-8 mb-3 mb-lg-0">
        <canvas id="courseChart" height="120"></canvas>
      </div>
      <div class="col-lg-4">
        <h6 class="mb-2">Course Mapping</h6>
        <div style="max-height:260px; overflow:auto;">
          <table class="table table-sm mapping-table">
            <thead><tr><th>Normalized</th><th>Master</th><th>Rovan</th></tr></thead>
            <tbody id="mappingBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- ============================ -->
  <!-- DATA TABLE -->
  <!-- ============================ -->
  <section class="card-block mb-4">

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">Detailed Report</h5>
      <div>
        <button id="downloadCSV" class="btn btn-sm btn-success">CSV</button>
        <button id="downloadXlsx" class="btn btn-sm btn-primary">XLSX</button>
      </div>
    </div>

    <div class="table-responsive">
      <table id="reportTable" class="display cell-border stripe" style="width:100%">
        <thead>
          <tr><th>Register No</th><th>Course</th><th>Master Mark</th><th>Rovan Mark</th><th>Status</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </section>

  <footer>Built with SheetJS • Chart.js • DataTables</footer>

</div>

<!-- ============================ -->
<!-- LIBRARIES -->
<!-- ============================ -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- ============================ -->
<!-- *** FULL JAVASCRIPT LOGIC *** -->
<!-- ============================ -->
<script>
/* -------------------- UTILITIES -------------------- */
const readFileAsArrayBuffer = (file) => new Promise((res, rej) => {
  let fr = new FileReader();
  fr.onload = e => res(e.target.result);
  fr.onerror = e => rej(e);
  fr.readAsArrayBuffer(file);
});

function normalizeString(v){
  if(v==null) return "";
  return String(v).trim().toUpperCase();
}

function normalizeCourseHeader(h){
  if(!h) return "";
  let s = String(h).toUpperCase().trim();
  s = s.replace(/\(.*?\)/g,"");
  s = s.replace(/\b(THEORY|LAB|PRACTICAL|INTERNAL|INTERNALS|IA)\b/gi,"");
  s = s.replace(/[^A-Z0-9]/g,"");
  return s.trim();
}

function isRegisterLike(s){
  return /\d/.test(s) && s.length>=3;
}

/* -------------------- PARSE TO ARRAY -------------------- */
async function parseSheet(file){
  const ab = await readFileAsArrayBuffer(file);
  const wb = XLSX.read(ab,{type:'array'});
  const ws = wb.Sheets[wb.SheetNames[0]];
  const arr = XLSX.utils.sheet_to_json(ws,{header:1,defval:""});
  return arr;
}

function arrayToDF(arr){
  let header = arr[0] || [];
  let rows = arr.slice(1).map(r => {
    let o={};
    header.forEach((h,i)=> o[h]=r[i]);
    return o;
  });
  return {header, rows};
}

function detectRegColumn(df){
  let cand=[];
  df.header.forEach(h=>{
    let H = String(h).toUpperCase();
    if(H.includes("REG")||H.includes("ROLL")) cand.push(h);
  });
  if(cand.length>0) return cand[0];
  return df.header[0];
}

/* -------------------- MATRIX BUILD -------------------- */
function dfToMatrix(df, regCol){
  let regs=new Set(), courses=new Set(), matrix={};
  let normMap={}; // normalized → original

  df.header.forEach(h=>{
    let n=normalizeCourseHeader(h);
    if(n){ 
      if(!normMap[n]) normMap[n]=new Set();
      normMap[n].add(h);
    }
  });

  df.rows.forEach(r=>{
    let reg = normalizeString(r[regCol]);
    if(!reg) return;
    regs.add(reg);
    matrix[reg] = matrix[reg] || {};

    df.header.forEach(h=>{
      if(h===regCol) return;
      let n=normalizeCourseHeader(h);
      if(!n) return;
      courses.add(n);
      matrix[reg][n] = r[h] ?? "";
    });
  });

  return {
    regs:[...regs].sort(),
    courses:[...courses].sort(),
    matrix,
    normMap
  };
}

/* -------------------- COMPARE -------------------- */
function compare(master, rovan){
  let regs=[...new Set([...master.regs,...rovan.regs])].sort();
  let courses=[...new Set([...master.courses,...rovan.courses])].sort();

  let rows=[];
  let stats={total:0,match:0,mis:0,missM:0,missR:0};

  regs.forEach(reg=>{
    courses.forEach(c=>{
      let m = normalizeString(master.matrix[reg]?.[c] || "");
      let r = normalizeString(rovan.matrix[reg]?.[c] || "");

      if(!m && !r) return;

      stats.total++;
      let status="";

      if(m && r){
        if(m===r) { stats.match++; status="Match"; }
        else { stats.mis++; status="Mismatch"; }
      }
      else if(m && !r){
        stats.missR++; status="Missing in Rovan";
      }
      else if(!m && r){
        stats.missM++; status="Missing in Master";
      }

      rows.push({
        reg, course:c,
        m: master.matrix[reg]?.[c] || "",
        r: rovan.matrix[reg]?.[c] || "",
        status
      });
    });
  });

  return {rows, stats};
}

/* -------------------- EVENT HANDLERS -------------------- */

let masterDF=null, rovanDF=null;

document.getElementById("masterFile").onchange = async(e)=>{
  let arr=await parseSheet(e.target.files[0]);
  masterDF=arrayToDF(arr);
  let col=detectRegColumn(masterDF);
  $("#masterRegCol").html(`<option>${col}</option>`);
};

document.getElementById("rovanFile").onchange = async(e)=>{
  let arr=await parseSheet(e.target.files[0]);
  rovanDF=arrayToDF(arr);
  let col=detectRegColumn(rovanDF);
  $("#rovanRegCol").html(`<option>${col}</option>`);
};

/* -------------------- COMPARE BUTTON -------------------- */
document.getElementById("compareBtn").onclick = ()=>{
  

  if(!masterDF || !rovanDF){
    alert("Upload both files");
    return;
  }

  let mCol=$("#masterRegCol").val();
  let rCol=$("#rovanRegCol").val();

  let M=dfToMatrix(masterDF, mCol);
  let R=dfToMatrix(rovanDF, rCol);

  let {rows, stats} = compare(M,R);

  // Update stats
  $("#totalCells").text(stats.total);
  $("#matches").text(stats.match);
  $("#mismatches").text(stats.mis);
  $("#missingCounts").text(`${stats.missM} / ${stats.missR}`);
  $("#matchPercent").text((stats.match/stats.total*100).toFixed(1)+"%");
  $("#mismatchPercent").text((stats.mis/stats.total*100).toFixed(1)+"%");

  // Mapping table
  let mapHtml="";
  let keys=[...new Set([...Object.keys(M.normMap),...Object.keys(R.normMap)])].sort();
  keys.forEach(k=>{
    let m=[...(M.normMap[k] || [])].join("<br>");
    let r=[...(R.normMap[k] || [])].join("<br>");
    mapHtml+=`<tr><td>${k}</td><td>${m}</td><td>${r}</td></tr>`;
  });
  $("#mappingBody").html(mapHtml);

  // Report table
  $("#reportTable").DataTable().destroy();
  $("#reportTable tbody").html("");

  rows.forEach(r=>{
    $("#reportTable tbody").append(`
      <tr class="status-${r.status.replaceAll(" ","")}">
        <td>${r.reg}</td>
        <td>${r.course}</td>
        <td>${r.m}</td>
        <td>${r.r}</td>
        <td>${r.status}</td>
      </tr>
    `);
  });

  $("#reportTable").DataTable();
};

  function detectMissingColumns(master, rovan) {
    const masterCols = new Set(master.courses);
    const rovanCols = new Set(rovan.courses);

    const masterOnly = [];
    const rovanOnly = [];

    masterCols.forEach(c => {
        if (!rovanCols.has(c)) masterOnly.push(c);
    });

    rovanCols.forEach(c => {
        if (!masterCols.has(c)) rovanOnly.push(c);
    });

    return {
        masterOnly,
        rovanOnly,
        countMasterOnly: masterOnly.length,
        countRovanOnly: rovanOnly.length
    };
}

/* -------------------- RESET -------------------- */
document.getElementById("resetBtn").onclick = ()=>{
  location.reload();
};

/* -------------------- TEMPLATE DOWNLOAD -------------------- */
document.getElementById("downloadMasterTpl").onclick = ()=>{
  let arr=[["RegNo","MA3351","PH3251","CS3391"],
  ["2123001",18,20,19]];
  let wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(arr),"Master");
  XLSX.writeFile(wb,"Master_Template.xlsx");
};

document.getElementById("downloadRovanTpl").onclick = ()=>{
  let arr=[["RegNo","CS3391","MA3351","PH3251"],
  ["2123001",19,18,20]];
  let wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(arr),"Rovan");
  XLSX.writeFile(wb,"Rovan_Template.xlsx");
};

/* -------------------- EXPORT CSV -------------------- */
document.getElementById("downloadCSV").onclick = ()=>{
  let table = $("#reportTable").DataTable();
  let csv="Register No,Course,Master,Rovan,Status\n";
  table.rows({search:'applied'}).every(function(){
    let d=this.data();
    csv+=d.join(",")+"\n";
  });
  let blob=new Blob([csv],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="Report.csv";
  a.click();
};

/* -------------------- EXPORT XLSX -------------------- */
document.getElementById("downloadXlsx").onclick = ()=>{
  let table=$("#reportTable").DataTable();
  let arr=[["Register No","Course","Master","Rovan","Status"]];
  table.rows({search:'applied'}).every(function(){
    arr.push(this.data());
  });
  let wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(arr),"Report");
  XLSX.writeFile(wb,"Report.xlsx");
};
</script>

</body>
</html>
